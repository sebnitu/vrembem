---
import Icon from "./Icon.astro";
import Popover from "./Popover.astro";

interface Props {
  nopre?: boolean;
  inline?: string;
  icon?: string;
}

const { inline, nopre, icon } = Astro.props;

const classes = ["code-block"];
if (inline) classes.push("code-block_inline");
if (icon) classes.push("has-icon");
---

<div class={classes.join(" ")}>
  {
    icon && (
      <span class="code-block__icon">
        <Icon name={icon} classes="icon_size_sm" />
      </span>
    )
  }
  {
    nopre ? (
      <slot />
    ) : inline ? (
      // prettier-ignore
      <pre tabindex="0" class="pre"><code set:html={inline} /></pre>
    ) : (
      // prettier-ignore
      <pre tabindex="0" class="pre"><slot /></pre>
    )
  }
  <Popover
    triggerClass="code-block__copy-button"
    aria-label="Copy code example"
    arrow
  >
    <Fragment slot="trigger">
      <Icon name="copy" classes="icon_size_sm" />
      <Icon
        name="check"
        classes="icon_size_sm foreground-primary-50 display-none"
      />
    </Fragment>
    Copied!
  </Popover>
</div>

<script>
  import { popover } from "../modules/usePopover";

  const btns = document.querySelectorAll(".code-block__copy-button");
  btns.forEach((btn: HTMLButtonElement) => {
    btn.addEventListener("click", () => {
      const code = btn
        .closest(".code-block")
        .querySelector("pre code") as HTMLElement;
      const text = code.innerText;
      const icons = btn.querySelectorAll(".icon");
      navigator.clipboard
        .writeText(text)
        .then(() => {
          btn.disabled = true;
          icons.forEach((icon) => icon.classList.toggle("display-none"));
          setTimeout(() => {
            btn.disabled = false;
            icons.forEach((icon) => icon.classList.toggle("display-none"));
            popover.close(btn.getAttribute("data-popover-trigger"));
          }, 2000);
        })
        .catch((error) => {
          console.error("Error:", error);
        });
    });
  });
</script>
