---
import Icon from "./Icon.astro";
import CodeBlock from "./CodeBlock.astro";

interface Props {
  data: {};
}

const { data } = Astro.props;
const props = Object.entries(data);
const keys = Object.keys(data);

function linkifyValue(value, keys) {
  if (typeof value !== "string") return value;
  // Sort keys by length descending to match longest first
  const sortedKeys = [...keys].sort((a, b) => b.length - a.length);
  // Only match if not followed or preceded by a dash or word char
  const pattern = new RegExp(
    sortedKeys
      .map(
        (k) => `(?<![\w-])${k.replace(/[.*+?^${}()|[\\]\\]/g, "\\$&")}(?![\w-])`
      )
      .join("|"),
    "g"
  );
  return value.replace(pattern, (match) => `<a href="#${match}">${match}</a>`);
}

// TODO:
// - [x] Capture the hash click and apply active class to row
// - [x] Add the ability to click cell to copy its contents
// - [ ] Implement search filter of table
// - [x] Allow clicking a CSS value to link to prop reference
// - [ ] Add active class to the "selected" table row
// - [x] Fix scrolling so that it's not cut off by header
---

<div class="reference-table">
  <table class="table">
    <tr>
      <th>Var</th>
      <th>Value</th>
    </tr>

    {
      props.map(([key, value]) => (
        <tr id={key}>
          <td>
            <a
              class="table-anchor"
              href={`#${key}`}
              aria-label={`Permalink to '${key}' CSS custom property`}
            >
              <Icon name="hash" classes="icon_size_sm" />
            </a>
            <CodeBlock>
              <code>{key}</code>
            </CodeBlock>
          </td>
          <td>
            {typeof value === "string" ? (
              <CodeBlock>
                <code set:html={linkifyValue(value, keys)} />
              </CodeBlock>
            ) : (
              <div class="scroll-box">
                {Object.entries(value).map(([theme, v]) => (
                  <div class="flex justify-content-between align-items-center">
                    <span>
                      <CodeBlock>
                        <code set:html={linkifyValue(v, keys)} />
                      </CodeBlock>
                    </span>
                    <span>
                      <span class="badge">{theme}</span>
                    </span>
                  </div>
                ))}
              </div>
            )}
          </td>
        </tr>
      ))
    }
  </table>
</div>

<script>
  // Build the docBlock array
  const props = [];
  const rows = document.querySelectorAll(".reference-table tr");
  rows.forEach((el) => {
    props.push({
      id: el.id,
      el: el
    });
  });

  const anchors = document.querySelectorAll(".reference-table a");

  anchors.forEach((anchor) => {
    anchor.addEventListener("click", (event) => {
      event.preventDefault();
      const hash = anchor.getAttribute("href");
      window.location.hash = hash;
      checkActiveBlock();
    });
  });

  // Check for active block function
  function checkActiveBlock() {
    const result = props.find((el) => {
      return `#${el.id}` === window.location.hash;
    });

    props.forEach((item) => {
      item.el.classList.remove("is-active");
    });

    if (result) {
      result.el.classList.add("is-active");

      // Scroll to the element after it's open. This is needed to ensure the
      // element's toggled height is factored into the scroll position.
      const el = document.querySelector(`#${result.id}`);
      if (el) el.scrollIntoView({ block: "center" });
    }
  }

  // Setup event listener for hash change and check for active block on load
  // and change.
  checkActiveBlock();
  window.addEventListener("hashchange", () => {
    checkActiveBlock();
  });
</script>
