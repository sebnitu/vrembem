---
import OnThisPageList from "./OnThisPageList.astro";

const { headings, menuClass } = Astro.props;

// Filter the headings to only display the ones we want.
const filteredHeadings = build(headings.filter((item) => item.depth === 2));

function build(headings) {
  const otp = [];
  const parentHeadings = new Map();
  headings.forEach((h) => {
    const heading = { ...h, subheadings: [] };
    parentHeadings.set(heading.depth, heading);
    // Change depth to 1 if your markdown includes your <h1>, else set to 2.
    const depth = 2;
    if (heading.depth === depth) {
      otp.push(heading);
    } else {
      parentHeadings.get(heading.depth - 1).subheadings.push(heading);
    }
  });
  return otp;
}
---

<nav>
  <h2 class="padding padding-y-sm">On this page</h2>
  <ul class={`menu menu_otp${menuClass ? " " + menuClass : ""}`}>
    {filteredHeadings.map((item) => <OnThisPageList {item} />)}
    <li class="menu__sep slide-up scroll-spy"></li>
    <li class="menu__item slide-up scroll-spy">
      <a href="#main" class="menu__action">Back to top</a>
    </li>
  </ul>
</nav>

<script>
  import { scrollSpy } from "../modules/scrollSpy";
  import { onThisPage } from "../modules/onThisPage";

  scrollSpy({
    value: 200,
  }).mount();

  onThisPage({
    selectorAnchors: ".menu_otp a",
  }).mount();
</script>

<style is:global>
  .menu_otp .menu__action {
    display: block;
    overflow: hidden;
    text-overflow: ellipsis;
  }
</style>
