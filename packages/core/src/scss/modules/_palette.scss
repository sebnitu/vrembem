@use "sass:map";
@use "sass:meta";
@use "../utilities/get-hs" as *;
@use "./config";
@use "./css";

// Set the initial CSS variables for the palette map
@if config.get("palette") {
  @each $name, $value in config.get("palette") {
    @include css.set("palette", "#{$name}", $value);
    @include css.set("palette", "#{$name}-hs", get-hs($value));
  }
}

/// Builds a palette map using values set in `config.get("palette")`.
///
/// @param {map} $seeds (config.get("palette"))
///   The seeds to generate a palette map from.
///
/// @access private
///
@mixin -rebuild-palette($action) {
  // Remove the palette component before building
  @include css.remove("palette");

  // Loop through the seeds and set the variables for each item in $seeds
  @each $name, $value in config.get("palette") {
    @include css.set("palette", "#{$name}", $value);
    @include css.set("palette", "#{$name}-hs", get-hs($value));
  }
}

/// Setup a config watcher for when the palette property changes.
@include config.watch("palette", "rebuild-palette", meta.get-mixin("-rebuild-palette"));

/// Returns a color value from the palette in various formats, based on the
/// provided name, lightness, and alpha values.
///
/// @param {string} $name
///   The color name to return a value for.
/// @param {percentage} $lightness (null)
///   The value to use for the lightness value.
/// @param {percentage} $alpha (null)
///   Optional alpha (opacity) value to apply to the returned color.
///
/// @return {color}
///   Return format depends on the requested value.
///
/// @example scss
///   // Return a color with the default lightness value or the raw value
///   $value: palette.get("primary");
///   // Returns: var(--vb-primary)
///
/// @example scss
///   // Return a color with a specified lightness value
///   $value: palette.get("primary", 20%);
///   // Returns: hsl(var(--vb-primary-hs) 20%)
///
/// @example scss
///   // Return a color with a specified lightness and alpha value
///   $value: palette.get("primary", 20%, 30%);
///   // Returns: hsl(var(--vb-primary-hs) 20% / 30%)
///
@function get($name, $lightness: config.get("palette-default"), $alpha: null) {
  // Throw error if palette name doesn't exist in palette map
  @if not map.has-key(config.get("palette"), $name) {
    @error 'Palette value could not be found: "#{$name}"';
  }

  // If an alpha value is passed, return hsl with the alpha
  @else if $alpha and $lightness {
    @return hsl(#{css.get("palette", "#{$name}-hs") $lightness + " / " + $alpha});
  }

  // If a query value is passed, return hsl with the lightness
  @else if $lightness {
    @return hsl(#{css.get("palette", "#{$name}-hs") $lightness});
  }

  // Else return the value stored in config
  @else {
    @return css.get("palette", $name);
  }
}
